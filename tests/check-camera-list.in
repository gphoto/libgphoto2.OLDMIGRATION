#!/bin/sh

top_builddir="@top_builddir@"
camlibdir="@camlibdir@"
libdir="@libdir@"
DESTDIR="@DESTDIR@"
MAKE="@MAKE@"

echo "---------------------"
pwd
echo "camlibdir=$camlibdir"
echo "libdir=$libdir"
echo "DESTDIR=$DESTDIR"
echo "top_builddir=$top_builddir"

CAMLIBS="${DESTDIR}${camlibdir}"

if test -d "${CAMLIBS}"; then
    :
elif test -d "$(pwd)/_inst/${camlibdir}"; then
    DESTDIR="$(pwd)/_inst"
    CAMLIBS="${DESTDIR}${camlibdir}"
    :
else
    DESTDIR="$(pwd)/_inst"
    CAMLIBS="${DESTDIR}${camlibdir}"
    (cd "${top_builddir}" && ${MAKE} DESTDIR="$DESTDIR" install)
    if test -d "${CAMLIBS}"; then
    	echo "Test installation successful"
    else
    	echo "Test installation failed"
    	exit 1
    fi
fi

LD_LIBRARY_PATH="$DESTDIR$libdir:$LD_LIBRARY_PATH"
export LD_LIBRARY_PATH
echo "Using camlib dir: $CAMLIBS"
export CAMLIBS

echo "====================="
pwd
echo "camlibdir=$camlibdir"
echo "libdir=$libdir"
echo "DESTDIR=$DESTDIR"
echo "top_builddir=$top_builddir"
echo "CAMLIBS=$CAMLIBS"
echo "LD_LIBRARY_PATH=$LD_LIBRARY_PATH"
echo "#####################"

./test-camera-list
